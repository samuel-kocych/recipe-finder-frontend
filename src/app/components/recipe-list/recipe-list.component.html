<!-- main container -->
<div class="container">
  @if (recipesData$ | async; as data) {

  <!-- page title -->
  <h1 class="page-title">Recipe Finder</h1>

  <!-- search and filters card -->
  <mat-card>
    <mat-card-content>
      <form
        (submit)="onSearch(true); $event.preventDefault()"
        class="search-form"
      >
        <!-- search row -->
        <div class="search-row">
          <mat-form-field appearance="outline">
            <mat-label>Search recipes</mat-label>
            <mat-icon matPrefix>search</mat-icon>
            <input matInput [(ngModel)]="searchTerm" name="searchTerm" />
          </mat-form-field>

          <button mat-raised-button color="primary" type="submit">
            <mat-icon>search</mat-icon>
            Search
          </button>

          <button mat-button type="button" (click)="showFilters = !showFilters">
            <mat-icon>{{
              showFilters ? "expand_less" : "expand_more"
            }}</mat-icon>
            {{ showFilters ? "Hide" : "Show" }} Filters
          </button>
        </div>

        <!-- filters row -->
        @if (showFilters) {
        <div class="filters-row">
          <mat-form-field appearance="outline">
            <mat-label>Ingredient</mat-label>
            <mat-icon matPrefix>restaurant</mat-icon>
            <input matInput [(ngModel)]="ingredient" name="ingredient" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Difficulty</mat-label>
            <mat-icon matPrefix>flag</mat-icon>
            <mat-select [(ngModel)]="difficulty" name="difficulty">
              <mat-option value="">All</mat-option>
              <mat-option value="easy">Easy</mat-option>
              <mat-option value="medium">Medium</mat-option>
              <mat-option value="hard">Hard</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Sort by</mat-label>
            <mat-icon matPrefix>sort</mat-icon>
            <mat-select [(ngModel)]="sortField" name="sortField">
              <mat-option value="dateCreated">Date Created</mat-option>
              <mat-option value="title">Title</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Order</mat-label>
            <mat-icon matPrefix>swap_vert</mat-icon>
            <mat-select [(ngModel)]="sortOrder" name="sortOrder">
              <mat-option value="desc">Newest First</mat-option>
              <mat-option value="asc">Oldest First</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        }
      </form>
    </mat-card-content>
  </mat-card>

  <!-- count and random recipe -->
  <mat-card class="stats-card">
    <mat-card-content class="stats-content">
      <div class="stat">
        <mat-icon>countertops</mat-icon>
        <span>Total recipes: {{ totalRecipes ?? "…" }}</span>
      </div>
      <button
        mat-stroked-button
        color="primary"
        (click)="loadRandom()"
        [disabled]="loadingRandom"
      >
        <mat-icon>shuffle</mat-icon>
        {{ loadingRandom ? "Loading…" : "Random Recipe" }}
      </button>
    </mat-card-content>
    <!-- random recipe now rendered in grid below when present -->
  </mat-card>

  <!-- recipes grid -->
  @if (data.recipes.length) {
  <div class="grid">
    @if (randomRecipe) {
    <mat-card
      class="recipe-card random-full"
      (click)="goToDetails(randomRecipe._id)"
    >
      <button
        mat-icon-button
        class="random-close-btn"
        aria-label="close random recipe"
        (click)="clearRandom(); $event.stopPropagation()"
      >
        <mat-icon>close</mat-icon>
      </button>
      <mat-card-header>
        <mat-card-title>{{
          randomRecipe.title || "Untitled recipe"
        }}</mat-card-title>
        <mat-card-subtitle>
          <mat-chip-set>
            <mat-chip>
              <mat-icon matChipAvatar>flag</mat-icon>
              {{
                randomRecipe.difficulty
                  ? (randomRecipe.difficulty | titlecase)
                  : "Not set"
              }}
            </mat-chip>
          </mat-chip-set>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-list>
          <mat-list-item>
            <mat-icon matListItemIcon>list</mat-icon>
            <span matListItemTitle
              >{{ randomRecipe.ingredients?.length || 0 }} ingredients</span
            >
          </mat-list-item>
          <mat-list-item>
            <mat-icon matListItemIcon>schedule</mat-icon>
            <span matListItemTitle>{{
              randomRecipe.dateUpdated || randomRecipe.dateCreated
                | date : "mediumDate"
            }}</span>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>
    } @for (recipe of data.recipes; track recipe._id) {
    <mat-card class="recipe-card" (click)="goToDetails(recipe._id)">
      <mat-card-header>
        <mat-card-title>{{ recipe.title || "Untitled recipe" }}</mat-card-title>
        <mat-card-subtitle>
          <mat-chip-set>
            <mat-chip>
              <mat-icon matChipAvatar>flag</mat-icon>
              {{
                recipe.difficulty ? (recipe.difficulty | titlecase) : "Not set"
              }}
            </mat-chip>
          </mat-chip-set>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-list>
          <mat-list-item>
            <mat-icon matListItemIcon>list</mat-icon>
            <span matListItemTitle
              >{{ recipe.ingredients?.length || 0 }} ingredients</span
            >
          </mat-list-item>
          <mat-list-item>
            <mat-icon matListItemIcon>schedule</mat-icon>
            <span matListItemTitle>{{
              recipe.dateUpdated || recipe.dateCreated | date : "mediumDate"
            }}</span>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>
    }
  </div>

  <!-- pagination -->
  @if (data.total > 10) {
  <mat-card class="pagination-card">
    <mat-card-actions>
      <button
        mat-button
        [disabled]="currentPage === 1"
        (click)="getPreviousPage()"
      >
        <mat-icon>chevron_left</mat-icon>
        Previous
      </button>

      <span class="page-info">
        Page {{ currentPage }} of {{ Math.ceil(data.total / 10) }}
      </span>

      <button
        mat-button
        [disabled]="currentPage === Math.ceil(data.total / 10)"
        (click)="getNextPage(data.total)"
      >
        Next
        <mat-icon>chevron_right</mat-icon>
      </button>
    </mat-card-actions>
  </mat-card>
  } }

  <!-- empty state -->
  @else {
  <mat-card class="empty-card">
    <mat-card-content>
      <mat-icon>restaurant</mat-icon>
      <p>
        {{
          data.hasSearched
            ? "No recipes found. Try another search!"
            : "No recipes available."
        }}
      </p>
    </mat-card-content>
  </mat-card>
  } } @else {
  <!-- initial loading -->
  <div class="loading">
    <mat-progress-spinner
      mode="indeterminate"
      diameter="48"
    ></mat-progress-spinner>
  </div>
  }
</div>
